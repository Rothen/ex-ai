import { PCA } from '../../src';
import { expect } from 'chai';
import * as fs from 'fs';
import { AverageCentroidCalculator } from '../../src/calculator/centroid_calculator/AverageCentroidCalculator';
import { Matrix } from '../../src/type/Matrix';

// tslint:disable-next-line:max-line-length
const pca1Mock = [[-2.264541728394902, -2.0864255006161607, -2.3679504490625285, -2.3041971611520116, -2.388777493505644, -2.070536807180556, -2.445711339630286, -2.233841858709268, -2.3419576764553924, -2.188675755280872, -2.1634865562665246, -2.327377754134376, -2.2240827220450043, -2.639716260844632, -2.192291508498431, -2.2514652145840675, -2.2027504800800877, -2.190179163791054, -1.89407429302367, -2.3399490704234105, -1.914556394959519, -2.2046453975338167, -2.7741697937051586, -1.8204115633372162, -2.228217499459727, -1.9570240073413991, -2.0520633112766893, -2.168193653345023, -2.1403059632841597, -2.2687901943878788, -2.144554429277137, -1.8319381022015897, -2.6082028676633495, -2.4379508590951446, -2.188675755280872, -2.2111198968124244, -2.0444165193198027, -2.188675755280872, -2.435952202966022, -2.1705472018842724, -2.286527238840933, -1.8717072235369536, -2.557834419537515, -1.9642792903547395, -2.1333728329200303, -2.075357592837309, -2.381258216802375, -2.398191687662641, -2.2267812130915208, -2.2059541686484043, 1.103993652804571, 0.7324814400086794, 1.2421095053189364, 0.3973072828233255, 1.0725939482015436, 0.38445814616900015, 0.7487150759515514, -0.49786338779812, 0.9262223675330968, 0.004968025584317415, -0.1246974613803726, 0.43873011778054505, 0.551633981422506, 0.7171650662368498, -0.03725838296569023, 0.8758905359406817, 0.348006401980207, 0.1533925445686655, 1.2153032092161524, 0.15694117564424898, 0.7382561043698943, 0.47236968234456667, 1.227988214083441, 0.6293810453149006, 0.7004727992084568, 0.8735369874014323, 1.2542221905224487, 1.3582398473872703, 0.6621261375659362, -0.04728151331988195, 0.12153420888011694, 0.01411822605138599, 0.2360108373265951, 1.0566914280905753, 0.22141708833021626, 0.43178316074105194, 1.049413355219179, 1.0358782103228226, 0.06706759987297868, 0.2754250662518325, 0.27233506626177056, 0.62317053972622, 0.3300053638372248, -0.37362762268737804, 0.2829443429551012, 0.08905311031900998, 0.22435678320860442, 0.5738834855584654, -0.45701287250467704, 0.2522444732694676, 1.8476725943096628, 1.1531898082521277, 2.2063494971265922, 1.4386854023261808, 1.8678907025555835, 2.7541967088257517, 0.358374474841666, 2.3030058981503188, 2.0017352992189155, 2.267554599102267, 1.3659094292022127, 1.5990645856518677, 1.884251853752073, 1.25308651437759, 1.4640615229856209, 1.5918093026385272, 1.4712801894655425, 2.4373784821935076, 3.309141182676078, 1.2539809866905764, 2.040496259663038, 0.973915114470472, 2.898064435843276, 1.3291936913234919, 1.7042407085196047, 1.9577276617934345, 1.171904507987867, 1.0197810528162612, 1.7860088612484668, 1.8647779127074655, 2.4354973914151423, 2.316082411961154, 1.8603714258523147, 1.1112717256759679, 1.1974691551180368, 2.8009494037340277, 1.5801552485205357, 1.3470444243548005, 0.9234329777663827, 1.8535519840664394, 2.0161572006777577, 1.9031168585994855, 1.1531898082521277, 2.0433084392878085, 2.001690966934996, 1.8705220714601238, 1.5584918907237155, 1.5208450639985889, 1.3763911906419264, 0.9592985756160365]];
// tslint:disable-next-line:max-line-length
const pca2Mock = [[-2.264541728394902, -2.0864255006161607, -2.3679504490625285, -2.3041971611520116, -2.388777493505644, -2.070536807180556, -2.445711339630286, -2.233841858709268, -2.3419576764553924, -2.188675755280872, -2.1634865562665246, -2.327377754134376, -2.2240827220450043, -2.639716260844632, -2.192291508498431, -2.2514652145840675, -2.2027504800800877, -2.190179163791054, -1.89407429302367, -2.3399490704234105, -1.914556394959519, -2.2046453975338167, -2.7741697937051586, -1.8204115633372162, -2.228217499459727, -1.9570240073413991, -2.0520633112766893, -2.168193653345023, -2.1403059632841597, -2.2687901943878788, -2.144554429277137, -1.8319381022015897, -2.6082028676633495, -2.4379508590951446, -2.188675755280872, -2.2111198968124244, -2.0444165193198027, -2.188675755280872, -2.435952202966022, -2.1705472018842724, -2.286527238840933, -1.8717072235369536, -2.557834419537515, -1.9642792903547395, -2.1333728329200303, -2.075357592837309, -2.381258216802375, -2.398191687662641, -2.2267812130915208, -2.2059541686484043, 1.103993652804571, 0.7324814400086794, 1.2421095053189364, 0.3973072828233255, 1.0725939482015436, 0.38445814616900015, 0.7487150759515514, -0.49786338779812, 0.9262223675330968, 0.004968025584317415, -0.1246974613803726, 0.43873011778054505, 0.551633981422506, 0.7171650662368498, -0.03725838296569023, 0.8758905359406817, 0.348006401980207, 0.1533925445686655, 1.2153032092161524, 0.15694117564424898, 0.7382561043698943, 0.47236968234456667, 1.227988214083441, 0.6293810453149006, 0.7004727992084568, 0.8735369874014323, 1.2542221905224487, 1.3582398473872703, 0.6621261375659362, -0.04728151331988195, 0.12153420888011694, 0.01411822605138599, 0.2360108373265951, 1.0566914280905753, 0.22141708833021626, 0.43178316074105194, 1.049413355219179, 1.0358782103228226, 0.06706759987297868, 0.2754250662518325, 0.27233506626177056, 0.62317053972622, 0.3300053638372248, -0.37362762268737804, 0.2829443429551012, 0.08905311031900998, 0.22435678320860442, 0.5738834855584654, -0.45701287250467704, 0.2522444732694676, 1.8476725943096628, 1.1531898082521277, 2.2063494971265922, 1.4386854023261808, 1.8678907025555835, 2.7541967088257517, 0.358374474841666, 2.3030058981503188, 2.0017352992189155, 2.267554599102267, 1.3659094292022127, 1.5990645856518677, 1.884251853752073, 1.25308651437759, 1.4640615229856209, 1.5918093026385272, 1.4712801894655425, 2.4373784821935076, 3.309141182676078, 1.2539809866905764, 2.040496259663038, 0.973915114470472, 2.898064435843276, 1.3291936913234919, 1.7042407085196047, 1.9577276617934345, 1.171904507987867, 1.0197810528162612, 1.7860088612484668, 1.8647779127074655, 2.4354973914151423, 2.316082411961154, 1.8603714258523147, 1.1112717256759679, 1.1974691551180368, 2.8009494037340277, 1.5801552485205357, 1.3470444243548005, 0.9234329777663827, 1.8535519840664394, 2.0161572006777577, 1.9031168585994855, 1.1531898082521277, 2.0433084392878085, 2.001690966934996, 1.8705220714601238, 1.5584918907237155, 1.5208450639985889, 1.3763911906419264, 0.9592985756160365], [-0.5057039027737834, 0.6554047293691382, 0.3184773108472506, 0.575367712533197, -0.6747673967025142, -1.5185485598885122, -0.07456267500687272, -0.24761393175226387, 1.095146362582957, 0.4486290483375607, -1.0705955760377257, -0.1585874546594747, 0.7091181580302279, 0.9382819821078557, -1.889978512316465, -2.7223710765744693, -1.5137502825462177, -0.5143043082206915, -1.4311107069412363, -1.1580334289850005, -0.43046516328013684, -0.9524573172889974, -0.48951702650349405, -0.10675079283540459, -0.16218616266619562, 0.6078925674838096, -0.26601431198165376, -0.5520164953235387, -0.33664040884505303, 0.31487860284052965, 0.4839420967692604, -0.4452668355028057, -1.828475192734101, -2.1853916156308926, 0.4486290483375607, 0.18433781054028012, -0.6849564262949355, 0.4486290483375607, 0.8821694147756187, -0.292726954966445, -0.46799171567093667, 2.327691606114912, 0.4538163804897945, -0.4973916400183821, -1.171432111774203, 0.6919173471364117, -1.150632592873666, 0.36239076472585846, -1.025482552823544, -0.032237845273778126, -0.8631124458513223, -0.5986355733419951, -0.6148224496122844, 1.7581689474435294, 0.21175790267989816, 0.591062468622739, -0.7786986113887798, 1.8488687712754452, -0.03033082678337876, 1.0294011124030906, 2.658062677961764, 0.058881285021456786, 1.772581564856258, 0.18543431450504633, 0.4327950987141713, -0.5099981510591453, 0.19062164665728032, 0.7907254562344879, 1.6333556445154862, 1.303103270172914, -0.40247038161853355, 0.4166082224438819, 0.9409147925302754, 0.41681164254177455, 0.06349392765170457, -0.25070861070205164, 0.08262009981311501, -0.32882026627039945, 0.2243460709434667, 1.0572124126050229, 1.5635923798655809, 1.5733923546480626, 0.7759237840118188, 0.63690128376894, 0.2808476930856427, -0.8551369202180006, -0.5221972645127744, 1.392466484387784, 0.21262073489339112, 1.3298159131577054, 1.1194415241194067, -0.02754263330229205, 0.9889007318191572, 2.017932265204176, 0.8539507169865527, 0.17490854779054402, 0.3804846594865479, 0.1537199740800674, 1.5394645102639837, 0.5958607459650336, -0.8716966617734104, 0.7013261138565783, -0.55447010493492, 0.05001052226888822, -0.2911928017611665, -0.7884322063548425, 1.5600945839772926, -0.40951669522194095, 0.7238653593126627, -1.9214429914653526, -0.6939480398041589, 0.4282488359003426, -0.41433275795008145, 1.167391335245249, 0.44414756947912637, -0.6770353716018493, -0.25319247196681305, -2.5567573414948, 0.002361320102086062, 1.7175838442659805, -0.9073987650150508, 0.571174376366269, -0.3977913591718654, 0.48676054190372686, -1.0141484248357826, -1.003334515429775, 0.3188966173105705, -0.06554296309664553, 0.1932727998568941, -0.5553815315789873, -0.24665446806897148, -2.6261838690226256, 0.18467239440998595, 0.2959861024303928, 0.8171677419136187, -0.8447481937849719, -1.0724744961271198, -0.42225596589554387, -0.01923037054689067, -0.6724227289716014, -0.6103970375551103, -0.6860248318586968, 0.7013261138565783, -0.8646848804720164, -1.048550046623415, -0.38282183762299554, 0.9053136014070693, -0.2667945748539084, -1.016361928794883, 0.022283944660569613]];

describe('PCA', () => {
    const iris = JSON.parse(fs.readFileSync('data/pca/iris.json').toString());
    const matrix: Matrix = [];

    before(() => {
        for (const iri of iris) {
            matrix.push([
                iri.sepal_length,
                iri.sepal_width,
                iri.petal_length,
                iri.peatl_width
            ]);
        }

        const mean = new AverageCentroidCalculator().calculate(matrix);
        const standardDeviation = [];


        for (let c = 0; c < matrix[0].length; c++) {
            standardDeviation[c] = 0;

            for (let r = 0; r < matrix.length; r++) {
                standardDeviation[c] += Math.pow(matrix[r][c] - mean[c], 2);
            }

            standardDeviation[c] = Math.sqrt(1 * standardDeviation[c] / matrix.length);
        }

        for (let c = 0; c < matrix[0].length; c++) {
            for (let r = 0; r < matrix.length; r++) {
                matrix[r][c] = (matrix[r][c] - mean[c]) / standardDeviation[c];
            }
        }
    });

    beforeEach(() => {
    });

    it('should be created', () => {
        const pca = new PCA();
        expect(pca).to.be.ok;
    });

    it('should calculate k-Means with defined centers correctly', () => {
        const copy1 = JSON.parse(JSON.stringify(matrix));
        const copy2 = JSON.parse(JSON.stringify(matrix));

        const pca = new PCA();
        const result = pca.learn(matrix);
        const adjustedData = pca.transform(copy1, 1);
        const adjustedDataByPercentage = pca.transformByPercentage(copy2, 83);
        const explainedPercentagePerDimension = pca.getExplainedPercentagePerDimension();

        expect(explainedPercentagePerDimension.size).to.equal(4);
        expect(explainedPercentagePerDimension.get(1)).to.equal(53.42728504910814);
        expect(explainedPercentagePerDimension.get(2)).to.equal(83.4837203545236);
        expect(explainedPercentagePerDimension.get(3)).to.equal(95.50457857077865);
        expect(explainedPercentagePerDimension.get(4)).to.equal(99.99999999999999);
        expect(adjustedData).to.deep.equal(pca1Mock);
        expect(adjustedDataByPercentage).to.deep.equal(pca2Mock);
    });
});
